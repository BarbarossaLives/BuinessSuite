{% extends "base.html" %}

{% block title %}Daily{% endblock %}

{% block content %}
  <div class="container py-5" style="background: url('/static/images/TTRPGwithcomputers.jpg') center center / cover no-repeat; position: relative;">
    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(34,34,34,0.7); z-index: 1;"></div>
    <div style="position: relative; z-index: 2;">
      <h2 class="text-center mb-4">Daily Page</h2>
      <div class="row">
        <div class="col-12 col-md-5 mb-3 mb-md-0" style="background: rgba(52,58,64,0.5); border: 2px solid #ffc107; min-height: 300px;">
          <div class="p-3 text-white">
            <div class="d-flex align-items-center mb-3">
              <label class="form-label mb-0 me-3 fs-5">Events</label>
              <input type="date" class="form-control form-control-sm w-auto" id="date-picker" />
            </div>
            <!-- Event List -->
            <div id="events-list"></div>
          </div>
        </div>
        <div class="col-12 col-md-5 mb-3 mb-md-0" style="background: rgba(73,80,87,0.5); border: 2px solid #0dcaf0; min-height: 300px;">
          <div class="p-3 text-white">
            <div class="mb-3 fw-bold fs-5">Current Project</div>
            <div class="mb-3">
              <label for="projectDropdown" class="form-label">Project</label>
              <select class="form-select" id="projectDropdown">
                {% for project in projects %}
                  <option value="{{ project.id }}" {% if project.id == selected_project_id %}selected{% endif %}>{{ project.name }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- Tasks for selected project -->
            <div id="projectTasks"></div>
          </div>
        </div>
        <div class="col-12 col-md-2" style="background: rgba(33,37,41,0.5); border: 2px solid #dc3545; min-height: 300px;">
          <div class="p-3 text-white">
            <div class="mb-4 fw-bold">Admin</div>
            <div class="d-flex flex-column gap-2">
              <a class="btn btn-primary w-100" id="create-event-btn" href="/create-event">Create Event</a>
              <button class="btn btn-secondary w-100" onclick="window.location.href='/create-project'">Create Project</button>
              <a class="btn btn-warning w-100" id="edit-project-btn" href="/edit-project/{{ selected_project_id }}">Edit Project</a>
              <button class="btn btn-success w-100" onclick="window.location.href='/create-project-ai'">Create Project with AI</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const eventList = document.getElementById('events-list');
  const datePicker = document.getElementById('date-picker');
  const projects = {{ projects|tojson }};
  const selectedProjectId = {{ selected_project_id if selected_project_id else 'null' }};
  const projectDropdown = document.getElementById('projectDropdown');
  const projectTasksDiv = document.getElementById('projectTasks');

  async function loadEvents() {
      const date = datePicker.value;
      const res = await fetch('/events');
      const events = await res.json();
      eventList.innerHTML = '';
      events
        .filter(ev => ev.start_time.slice(0,10) === date)
        .forEach(ev => {
          const a = document.createElement('a');
          a.className = 'event-item mb-2 p-2 border rounded d-block' + (ev.completed ? ' bg-success-subtle text-decoration-line-through' : '');
          a.style.cursor = 'pointer';
          a.textContent = `${ev.name} (${ev.start_time.replace('T',' ').slice(0,16)})`;
          a.href = `/edit-event/${ev.id}`;
          eventList.appendChild(a);
        });
  }

  function renderTasks(projectId) {
    const project = projects.find(p => p.id == projectId);
    projectTasksDiv.innerHTML = '';
    if (!project || !project.tasks.length) {
      projectTasksDiv.innerHTML = '<div class="text-muted">No tasks for this project.</div>';
      return;
    }
    project.tasks.forEach(task => {
      const div = document.createElement('div');
      div.className = 'mb-3 p-2 rounded bg-dark border border-info';
      div.innerHTML = `<div class='fw-bold'>${task.completed ? `<span class='toggle-complete' data-task-id='${task.id}' style='cursor:pointer;'>✔️</span> ` : `<span class='toggle-complete' data-task-id='${task.id}' style='cursor:pointer; color: #888;'>⬜</span> `}${task.name}</div>
        <div>${task.description || ''}</div>
        <div class='small text-muted'>${task.due_date ? 'Due: ' + task.due_date : ''}${task.completed ? ' | Completed' : ''}</div>`;
      projectTasksDiv.appendChild(div);
    });
    // Add event listeners for toggling completion
    projectTasksDiv.querySelectorAll('.toggle-complete').forEach(el => {
      el.onclick = async function(e) {
        e.stopPropagation();
        const taskId = this.getAttribute('data-task-id');
        await fetch(`/tasks/${taskId}/toggle-completed`, {method: 'PATCH'});
        renderTasks(projectDropdown.value);
      };
    });
  }

  projectDropdown.onchange = function() {
    renderTasks(this.value);
    document.getElementById('edit-project-btn').href = `/edit-project/${this.value}`;
  };

  datePicker.onchange = loadEvents;
  window.onload = function() {
    // Set date picker to today by default
    const today = new Date().toISOString().slice(0,10);
    datePicker.value = today;
    loadEvents();
    if (selectedProjectId) {
      renderTasks(selectedProjectId);
      document.getElementById('edit-project-btn').href = `/edit-project/${selectedProjectId}`;
    } else if (projects.length) {
      renderTasks(projects[0].id);
      document.getElementById('edit-project-btn').href = `/edit-project/${projects[0].id}`;
    }
  };
  </script>

{% endblock %} 