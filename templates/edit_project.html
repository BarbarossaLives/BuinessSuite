{% extends "base.html" %}
{% block title %}Edit Project{% endblock %}
{% block content %}
<div class="container py-5">
  <h2 class="mb-4">Edit Project</h2>
  <form method="post" action="/edit-project/{{ project.id }}" id="edit-project-form">
    <div class="mb-3">
      <label class="form-label">Project Name</label>
      <input type="text" class="form-control" name="name" value="{{ project.name }}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="description">{{ project.description }}</textarea>
    </div>
    <hr>
    <h4>Tasks</h4>
    <div id="tasks-container">
      {% for task in tasks %}
      <div class="card mb-3 p-3 task-item" data-order="{{ task.order }}">
        <input type="hidden" name="tasks-{{ loop.index0 }}-id" value="{{ task.id }}">
        <input type="hidden" name="tasks-{{ loop.index0 }}-order" class="task-order" value="{{ task.order }}">
        <div class="mb-2 d-flex align-items-center">
          <span class="move-task btn btn-sm btn-outline-secondary me-2">⇅</span>
          <input type="text" class="form-control me-2" name="tasks-{{ loop.index0 }}-name" value="{{ task.name }}" required>
          <button type="button" class="btn btn-danger btn-sm delete-task">Delete</button>
        </div>
        <div class="mb-2">
          <textarea class="form-control" name="tasks-{{ loop.index0 }}-description" placeholder="Description">{{ task.description }}</textarea>
        </div>
        <div class="mb-2">
          <input type="date" class="form-control" name="tasks-{{ loop.index0 }}-due_date" value="{{ task.due_date }}">
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" name="tasks-{{ loop.index0 }}-completed" id="tasks-{{ loop.index0 }}-completed" {% if task.completed %}checked{% endif %}>
          <label class="form-check-label" for="tasks-{{ loop.index0 }}-completed">Completed</label>
        </div>
      </div>
      {% endfor %}
    </div>
    <button type="button" class="btn btn-secondary mb-3" id="add-task-btn">Add Task</button>
    <hr>
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="/daily" class="btn btn-secondary ms-2">Cancel</a>
    <button type="button" class="btn btn-danger ms-2" id="delete-project-btn">Delete Project</button>
  </form>
</div>
<script>
function updateTaskOrders() {
  document.querySelectorAll('.task-item').forEach((el, idx) => {
    el.querySelector('.task-order').value = idx;
  });
}

document.getElementById('add-task-btn').onclick = function() {
  const idx = document.querySelectorAll('.task-item').length;
  const div = document.createElement('div');
  div.className = 'card mb-3 p-3 task-item';
  div.innerHTML = `
    <input type="hidden" name="tasks-${idx}-order" class="task-order" value="${idx}">
    <div class="mb-2 d-flex align-items-center">
      <span class="move-task btn btn-sm btn-outline-secondary me-2">⇅</span>
      <input type="text" class="form-control me-2" name="tasks-${idx}-name" placeholder="Task Name" required>
      <button type="button" class="btn btn-danger btn-sm delete-task">Delete</button>
    </div>
    <div class="mb-2">
      <textarea class="form-control" name="tasks-${idx}-description" placeholder="Description"></textarea>
    </div>
    <div class="mb-2">
      <input type="date" class="form-control" name="tasks-${idx}-due_date">
    </div>
    <div class="form-check mb-2">
      <input class="form-check-input" type="checkbox" name="tasks-${idx}-completed" id="tasks-${idx}-completed">
      <label class="form-check-label" for="tasks-${idx}-completed">Completed</label>
    </div>
  `;
  document.getElementById('tasks-container').appendChild(div);
  updateTaskOrders();
  addTaskListeners(div);
};

function addTaskListeners(taskDiv) {
  // Delete
  taskDiv.querySelector('.delete-task').onclick = function() {
    taskDiv.remove();
    updateTaskOrders();
  };
  // Move
  taskDiv.querySelector('.move-task').onmousedown = function(e) {
    e.preventDefault();
    let dragging = taskDiv;
    let startY = e.clientY;
    function onMouseMove(ev) {
      let delta = ev.clientY - startY;
      if (Math.abs(delta) > 30) {
        let sibling = delta > 0 ? dragging.nextElementSibling : dragging.previousElementSibling;
        if (sibling && sibling.classList.contains('task-item')) {
          if (delta > 0) sibling.after(dragging);
          else sibling.before(dragging);
          updateTaskOrders();
          startY = ev.clientY;
        }
      }
    }
    function onMouseUp() {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    }
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  };
}
document.querySelectorAll('.task-item').forEach(addTaskListeners);

document.getElementById('delete-project-btn').onclick = function() {
  if (confirm('Are you sure you want to delete this project and all its tasks?')) {
    fetch('/delete-project/{{ project.id }}', {method: 'POST'})
      .then(() => window.location.href = '/daily');
  }
};
</script>
{% endblock %} 